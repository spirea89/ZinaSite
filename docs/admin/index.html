<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Zina Admin | Decap CMS</title>
  <link rel="stylesheet" href="/styles.css" />
</head>

<body class="cms-shell">
  <header class="hero hero-small">
    <div class="hero-content">
      <div class="hero-panel">
        <p class="eyebrow">Admin</p>
        <h1>Article Editor</h1>
        <p class="lead">Manage Zina articles with Netlify Identity + Git Gateway.</p>

        <div class="actions">
          <a class="button ghost" href="/">Back to Site</a>
          <button id="cms-login" type="button" class="button">Login</button>
          <button id="cms-logout" type="button" class="button ghost">Logout</button>
        </div>
      </div>
    </div>
  </header>

  <main class="content">
    <div class="panel">
      <p class="muted">
        The editor loads after successful Netlify Identity login. Invited users can publish directly
        through Git Gateway without GitHub access.
      </p>
      <noscript>
        <p class="muted">JavaScript is required to use the admin panel.</p>
      </noscript>
      <p id="cms-status" class="muted" style="margin-top: 12px;"></p>
    </div>
  </main>

  <!-- Netlify Identity MUST be loaded before Decap CMS -->
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>

  <script>
    (function () {
      const loginButton = document.getElementById("cms-login");
      const logoutButton = document.getElementById("cms-logout");
      const statusEl = document.getElementById("cms-status");

      function setStatus(msg) {
        if (statusEl) statusEl.textContent = msg || "";
      }

      function updateButtons(userPresent) {
        if (loginButton) loginButton.style.display = userPresent ? "none" : "inline-flex";
        if (logoutButton) logoutButton.style.display = userPresent ? "inline-flex" : "none";
      }

      function safeOpenIdentity() {
        try {
          // Ensures the modal opens even if the widget needs init first
          window.netlifyIdentity.open();
        } catch (e) {
          console.error("[ZiNa Admin] Failed to open Netlify Identity modal:", e);
          setStatus("Login modal could not open. Please refresh and try again.");
        }
      }

      if (!window.netlifyIdentity) {
        console.error("[ZiNa Admin] Netlify Identity widget did not load.");
        setStatus("Netlify Identity failed to load. Check blockers/extensions and try again.");
        updateButtons(false);
        return;
      }

      // Hook up buttons
      if (loginButton) loginButton.addEventListener("click", safeOpenIdentity);
      if (logoutButton) logoutButton.addEventListener("click", () => window.netlifyIdentity.logout());

      // Identity lifecycle
      window.netlifyIdentity.on("init", (user) => {
        updateButtons(Boolean(user));

        if (user) {
          setStatus(`Logged in as ${user.email || "user"}.`);
        } else {
          setStatus("Not logged in. Please log in to publish articles.");

          // Auto-open login modal for convenience:
          // If you DON'T want auto-open, comment out the next line.
          safeOpenIdentity();

          // After successful login, return to /admin/ (keeps paths consistent)
          window.netlifyIdentity.on("login", () => {
            updateButtons(true);
            setStatus("Login successful. Loading editorâ€¦");
            window.location.assign("/admin/");
          });
        }
      });

      window.netlifyIdentity.on("logout", () => {
        updateButtons(false);
        setStatus("Logged out.");
        window.location.assign("/");
      });

      // Initialize identity (some browsers/extensions behave better with explicit init)
      try {
        window.netlifyIdentity.init({ locale: "en" });
      } catch (e) {
        console.error("[ZiNa Admin] netlifyIdentity.init failed:", e);
        setStatus("Identity initialization failed. Please refresh and try again.");
      }
    })();
  </script>
</body>
</html>
